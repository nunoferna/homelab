# ðŸ” Secrets Management

This document outlines the **static secrets** required for the Homelab.

These values **must not** be stored in Git. The Source of Truth for all secrets is **Vault**. Secrets are delivered to pods via the **External Secrets Operator (ESO)**, which reads from Vault and creates native Kubernetes Secrets.

```
Vault KV / Database Engine
        â”‚
        â–¼  (ClusterSecretStore + ExternalSecret)
Kubernetes Secret
        â”‚
        â–¼  (envFrom / secretRef)
Application Pod
```

## âš ï¸ Order of Operations

1.  **Apply Terraform First:**
    You must run the Terraform stacks (specifically `terraform/vault`) **before** creating these secrets. Terraform configures the Vault Auth Methods, Roles, and Policies that allow applications to read these secrets.

    ```bash
    cd terraform/vault && terraform apply
    ```

    This creates the `external-secrets` Vault auth role used by ESO.

2.  **Insert Secrets into Vault:**
    Follow the guide below. ESO will automatically reconcile `ExternalSecret` resources and create the Kubernetes Secrets.

3.  **Sync ArgoCD:**
    ArgoCD deploys ESO and the `ExternalSecret` manifests; ESO handles the rest.

---

## ðŸ› ï¸ How to Insert Secrets into Vault

### Method 1: Vault UI (Recommended)

This is the easiest way to visualize and manage secrets.

1.  **Access:** Open [https://vault.apps.internal](https://vault.apps.internal) in your browser.
2.  **Login:**
    - **Method:** Token
    - **Token:** Use your **Root Token** (saved during the initial `vault operator init` process).
3.  **Navigate:** Click on `secret/` (KV Engine) -> **Create Secret**.
4.  **Input:**
    - **Path for Secret:** Enter the path defined in the list below (e.g., `pihole/custom-env`).
    - **Secret Data:** Add the Key and Value pairs.
5.  **Save:** Click **Save**.

### Method 2: Vault CLI (Scriptable)

```bash
kubectl exec -ti vault-0 -n vault -- sh
# Inside the pod:
vault kv put secret/pihole/credentials password="my-pihole-password"
```

---

## ðŸ“‹ Required Secrets

### 1. Pi-hole (AdBlocking)

- **Vault Path:** `secret/pihole/credentials`
- **ESO flow:** `ExternalSecret` â†’ k8s Secret `pihole-credentials` â†’ `envFrom` in pihole Pod
- **Keys:**
  - `password`: Pi-hole web UI / FTL API password

### 2. Backstage (Developer Portal)

- **Vault Path:** `secret/backstage/github`
- **ESO flow:** `ExternalSecret` â†’ k8s Secret `backstage-github` â†’ `envFrom` in backstage Pod
- **Keys:**
  - `client_id`: GitHub OAuth App Client ID
  - `client_secret`: GitHub OAuth App Client Secret
  - `app_id`: GitHub App ID
  - `private_key`: GitHub App private key (PEM)

> **Dynamic DB credentials** (`POSTGRES_USER` / `POSTGRES_PASSWORD`) are generated by Vault's database secrets engine and refreshed every 30 min by ESO â€” no manual entry needed.

### 3. Tailscale (VPN)

- **Vault Path:** `secret/tailscale/credentials`
- **ESO flow:** `ExternalSecret` â†’ k8s Secret `operator-oauth` â†’ Tailscale Operator reads natively
- **Keys:**
  - `client_id`: Tailscale OAuth App client ID
  - `client_secret`: Tailscale OAuth App client secret

### 4. Cert-Manager (DNS Challenges)

- **Vault Path:** `secret/cert-manager/cloudflare`
- **Used By:** Cert-Manager (DNS-01 Issuer)
- **Keys:**
  - `api-token`: Cloudflare API Token (Edit Zone DNS permissions).
- _Note: Only required if using Let's Encrypt DNS-01 validation._

### 5. Loki (Object Storage)

- **Vault Path:** `secret/observability/loki`
- **Used By:** Loki (S3 Storage)
- **Keys:**
  - `access_key_id`: AWS/Minio Access Key.
  - `secret_access_key`: AWS/Minio Secret Key.
