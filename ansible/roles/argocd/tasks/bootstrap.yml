---
- name: Create temporary directory for GitOps manifests
  ansible.builtin.file:
    path: "{{ argocd_gitops_temp_dir }}"
    state: directory
    mode: "0755"
  tags: bootstrap

- name: Copy Root Application
  ansible.builtin.copy:
    src: application.yaml
    dest: "{{ argocd_gitops_temp_dir }}/application.yaml"
    mode: "0644"
  tags: bootstrap

- name: Apply Root Application
  ansible.builtin.command: >
    kubectl apply -f {{ argocd_gitops_temp_dir }}/application.yaml
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: argocd_application
  changed_when: "'created' in argocd_application.stdout or 'configured' in argocd_application.stdout"
  tags: bootstrap

- name: Remove temporary GitOps manifests
  ansible.builtin.file:
    path: "{{ argocd_gitops_temp_dir }}"
    state: absent
  tags: bootstrap

- name: Display GitOps bootstrap status
  ansible.builtin.debug:
    msg:
      - "âœ“ Root Application deployed"
  tags: bootstrap
