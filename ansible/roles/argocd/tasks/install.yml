---
- name: Add ArgoCD Helm repository
  kubernetes.core.helm_repository:
    name: argo
    repo_url: https://argoproj.github.io/argo-helm
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig }}"
  tags: [k3s, argocd]

- name: Install ArgoCD via Helm
  kubernetes.core.helm:
    name: argocd
    chart_ref: argo/argo-cd
    release_namespace: "{{ argocd_namespace }}"
    create_namespace: true
    values_files:
      - "{{ playbook_dir }}/../../gitops/infrastructure/argocd/values.yaml"
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig }}"
  tags: [k3s, argocd]

- name: Wait for ArgoCD to be ready
  ansible.builtin.command: k3s kubectl -n "{{ argocd_namespace }}" rollout status deployment/argocd-server --timeout=300s
  changed_when: false
  tags: [k3s, argocd]

- name: Display ArgoCD installation status
  ansible.builtin.debug:
    msg: "âœ“ ArgoCD installed in {{ argocd_namespace }} namespace"
  tags: install
