---

- name: Include Raspberry Pi preparation tasks
  ansible.builtin.include_tasks: rpi.yml
  when: ansible_facts['lsb']['id'] == "Raspbian" or ansible_facts['board'] is defined
  tags: [k3s, raspberry_pi]

- name: Check if k3s is already installed
  ansible.builtin.stat:
    path: "{{ k3s_binary_path }}"
  register: k3s_binary
  tags: k3s

- name: Include k3s configuration tasks
  ansible.builtin.include_tasks: configure.yml
  tags: [k3s, config]

- name: Include k3s installation tasks
  ansible.builtin.include_tasks: install.yml
  tags: [k3s, install]

- name: Include kubeconfig setup tasks
  ansible.builtin.include_tasks: kubeconfig.yml
  tags: [k3s, kubeconfig]

- name: Flush handlers to ensure k3s is running
  ansible.builtin.meta: flush_handlers
  tags: k3s

- name: Include k3s verification tasks
  ansible.builtin.include_tasks: verify.yml
  tags: [k3s, verify]

- name: Wait for k3s to be ready
  ansible.builtin.command: k3s kubectl wait --for=condition=Ready node --all --timeout=300s
  changed_when: false
  tags: k3s

- name: Install Gateway API CRDs
  ansible.builtin.command: >
    k3s kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.2.1/standard-install.yaml
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig }}"
  register: k3s_gateway_api_crds
  changed_when: "'created' in k3s_gateway_api_crds.stdout or 'configured' in k3s_gateway_api_crds.stdout"
  tags: [k3s, cilium]

- name: Check if Helm is installed
  ansible.builtin.command: helm version
  register: k3s_helm_check
  ignore_errors: true
  changed_when: false
  tags: [k3s, helm]

- name: Install pinned Helm v3
  when: k3s_helm_check.rc != 0 or 'v3' not in k3s_helm_check.stdout
  tags: [k3s, helm]
  block:
    - name: Download Helm 3 installation script
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        dest: /tmp/get_helm.sh
        mode: '0700'

    - name: Run Helm installation script
      ansible.builtin.command: /tmp/get_helm.sh
      environment:
        HELM_INSTALL_DIR: /usr/local/bin
        DESIRED_VERSION: v3.19.5
      changed_when: true

- name: Add Cilium Helm repository
  kubernetes.core.helm_repository:
    name: cilium
    repo_url: https://helm.cilium.io/
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig }}"
  tags: [k3s, cilium]

- name: Install Cilium CNI (required before ArgoCD)
  kubernetes.core.helm:
    name: cilium
    chart_ref: cilium/cilium
    release_namespace: kube-system
    create_namespace: true
    values_files:
      - "{{ role_path }}/files/cilium-values.yaml"
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig }}"
  tags: [k3s, cilium]

- name: Wait for Cilium to be ready
  ansible.builtin.command: k3s kubectl -n kube-system rollout status ds/cilium --timeout=300s
  changed_when: false
  tags: [k3s, cilium]

- name: Apply Cilium LoadBalancer IP Pool manifest
  ansible.builtin.command: "k3s kubectl apply -f {{ role_path }}/files/lbippool.yaml"
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig }}"
  register: k3s_lbpool_apply
  changed_when: "'configured' in k3s_lbpool_apply.stdout or 'created' in k3s_lbpool_apply.stdout"
  tags: [k3s, cilium]

- name: Apply Cilium L2 Announcement Policy manifest
  ansible.builtin.command: "k3s kubectl apply -f {{ role_path }}/files/l2announcementpolicy.yaml"
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig }}"
  register: k3s_l2policy_apply
  changed_when: "'configured' in k3s_l2policy_apply.stdout or 'created' in k3s_l2policy_apply.stdout"
  tags: [k3s, cilium]
