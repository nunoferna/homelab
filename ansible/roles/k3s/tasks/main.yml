---

- name: Include Raspberry Pi preparation tasks
  ansible.builtin.include_tasks: rpi.yml
  when: ansible_facts['lsb']['id'] == "Raspbian" or ansible_facts['board'] is defined
  tags: [k3s, raspberry_pi]

- name: Check if k3s is already installed
  ansible.builtin.stat:
    path: "{{ k3s_binary_path }}"
  register: k3s_binary
  tags: k3s

- name: Include k3s configuration tasks
  ansible.builtin.include_tasks: configure.yml
  tags: [k3s, config]

- name: Include k3s installation tasks
  ansible.builtin.include_tasks: install.yml
  tags: [k3s, install]

- name: Include kubeconfig setup tasks
  ansible.builtin.include_tasks: kubeconfig.yml
  tags: [k3s, kubeconfig]

- name: Flush handlers to ensure k3s is running
  ansible.builtin.meta: flush_handlers
  tags: k3s

- name: Include k3s verification tasks
  ansible.builtin.include_tasks: verify.yml
  tags: [k3s, verify]
