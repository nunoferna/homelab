---
- name: Check if k3s kubeconfig exists
  ansible.builtin.stat:
    path: "{{ k3s_system_kubeconfig }}"
  register: k3s_kubeconfig_exists
  tags: kubeconfig
  become: true

- name: Configure user kubeconfig access
  when: k3s_kubeconfig_exists.stat.exists
  block:
    - name: Ensure .kube directory exists
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.kube"
        state: directory
        mode: "0755"
      tags: kubeconfig

    - name: Copy k3s kubeconfig to user directory
      ansible.builtin.copy:
        src: "{{ k3s_system_kubeconfig }}"
        dest: "{{ k3s_kubeconfig }}"
        remote_src: true
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_id }}"
        mode: "0600"
      tags: kubeconfig
      become: true

    - name: Display kubeconfig setup status
      ansible.builtin.debug:
        msg: "Kubeconfig copied to {{ k3s_kubeconfig }} for user {{ ansible_user_id }}"
      tags: kubeconfig
