---
- name: Ensure Gateway API cache directory exists
  ansible.builtin.file:
    path: "{{ cilium_gateway_api_cache_dir }}"
    state: directory
    mode: "0755"
  register: cilium_cache_dir_created
  failed_when: false
  tags: gateway_api

- name: Set fallback cache directory if primary fails
  ansible.builtin.set_fact:
    cilium_effective_gateway_api_cache_dir: "{{ cilium_gateway_api_fallback_cache_dir if cilium_cache_dir_created.failed else cilium_gateway_api_cache_dir }}"
    cilium_effective_gateway_api_cache_file: >-
      {{
        cilium_gateway_api_fallback_cache_dir + '/standard-install.yaml'
        if cilium_cache_dir_created.failed
        else cilium_gateway_api_cache_file
      }}
  tags: gateway_api

- name: Ensure effective Gateway API cache directory exists
  ansible.builtin.file:
    path: "{{ cilium_effective_gateway_api_cache_dir }}"
    state: directory
    mode: "0755"
  when: cilium_cache_dir_created.failed
  tags: gateway_api

- name: Check if Gateway API CRDs are cached
  ansible.builtin.stat:
    path: "{{ cilium_effective_gateway_api_cache_file }}"
  register: cilium_gateway_api_cached
  tags: gateway_api

- name: Download Gateway API CRDs
  ansible.builtin.get_url:
    url: "{{ cilium_gateway_api_crds_url }}"
    dest: "{{ cilium_effective_gateway_api_cache_file }}"
    mode: "0644"
    timeout: 60
  register: cilium_gateway_api_download
  retries: "{{ cilium_gateway_api_download_retries }}"
  delay: "{{ cilium_gateway_api_download_delay }}"
  when: not cilium_gateway_api_cached.stat.exists
  tags: gateway_api

- name: Apply Gateway API CRDs
  ansible.builtin.command: >
    kubectl apply -f {{ cilium_effective_gateway_api_cache_file }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: gateway_api_apply
  changed_when: >
    'created' in gateway_api_apply.stdout or
    'configured' in gateway_api_apply.stdout
  tags: gateway_api

- name: Wait for Gateway API CRDs to be established
  ansible.builtin.command: >
    kubectl wait --for=condition=Established
    crd/{{ cilium_gateway_api_gatewayclass_crd }} --timeout={{ cilium_gateway_api_crd_timeout }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  changed_when: false
  tags: gateway_api

- name: Display Gateway API installation status
  ansible.builtin.debug:
    msg: "Gateway API CRDs ({{ cilium_gateway_api_version }}) installed and established"
  tags: gateway_api
