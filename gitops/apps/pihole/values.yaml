replicas: 2

podAnnotations:
  vault.hashicorp.com/agent-inject: "true"
  vault.hashicorp.com/role: "pihole"
  # Pre-populate secrets before main container starts
  vault.hashicorp.com/agent-pre-populate-only: "true"
  # Inject secret as environment variable export statement
  vault.hashicorp.com/agent-inject-secret-web-password: "secret/data/pihole/credentials"
  vault.hashicorp.com/agent-inject-template-web-password: |
    {{- with secret "secret/data/pihole/credentials" -}}
    export FTLCONF_webserver_api_password="{{ .Data.data.password }}"
    {{- end }}
  vault.hashicorp.com/agent-inject-secret-metrics-password: "secret/data/pihole/credentials"
  vault.hashicorp.com/agent-inject-template-metrics-password: |
    {{- with secret "secret/data/pihole/credentials" -}}
    {{ .Data.data.password }}
    {{- end }}

command: ["/bin/bash", "-c"]
args:
  - source /vault/secrets/web-password && exec start.sh

pihole:
  web:
    skipPasswordEnv: true
  lists:
    adlists:
      # HaGeZi Collections
      - address: https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/gambling.txt
      - address: https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/spam-tlds.txt
      - address: https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/tif.txt
      - address: https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/ultimate.txt

      # Firebog Suspicious Lists
      - address: https://raw.githubusercontent.com/PolishFiltersTeam/KADhosts/master/KADhosts.txt
      - address: https://raw.githubusercontent.com/FadeMind/hosts.extras/master/add.Spam/hosts
      - address: https://v.firebog.net/hosts/static/w3kbl.txt

      # Firebog Advertising Lists
      - address: https://adaway.org/hosts.txt
      - address: https://v.firebog.net/hosts/AdguardDNS.txt
      - address: https://raw.githubusercontent.com/anudeepND/blacklist/master/adservers.txt
      - address: https://v.firebog.net/hosts/Easylist.txt
      - address: https://raw.githubusercontent.com/FadeMind/hosts.extras/master/UncheckyAds/hosts

      # Firebog Tracking & Telemetry Lists
      - address: https://v.firebog.net/hosts/Easyprivacy.txt
      - address: https://v.firebog.net/hosts/Prigent-Ads.txt
      - address: https://raw.githubusercontent.com/FadeMind/hosts.extras/master/add.2o7Net/hosts
      - address: https://raw.githubusercontent.com/crazy-max/WindowsSpyBlocker/master/data/hosts/spy.txt
      - address: https://hostfiles.frogeye.fr/firstparty-trackers-hosts.txt

      # Firebog Malicious Lists
      - address: https://v.firebog.net/hosts/Prigent-Crypto.txt
      - address: https://raw.githubusercontent.com/FadeMind/hosts.extras/master/add.Risk/hosts
    
  ftl:
    dns:
      upstreams:
        - 1.0.0.1
        - 1.1.1.1
      service:
        enabled: true
        type: LoadBalancer

metrics:
  enabled: false
  dashboards:
    enabled: true
  serviceMonitor:
    enabled: true
    labels:
      release: kube-prometheus-stack
  initContainers:
    - name: prepare-metrics-env
      image: busybox:latest
      command: ["sh", "-c"]
      args:
        - |
          # Wait for vault secrets to be available
          while [ ! -f /vault/secrets/metrics-password ]; do
            echo "Waiting for Vault secrets..."
            sleep 1
          done
          PASSWORD=$(cat /vault/secrets/metrics-password)
          cp /bin/sh /shared/sh
          cat > /shared/run-exporter.sh << 'EOF'
          export PIHOLE_PASSWORD="PASSWORD_PLACEHOLDER"
          exec /root/pihole-exporter
          EOF
          sed -i "s|PASSWORD_PLACEHOLDER|${PASSWORD}|" /shared/run-exporter.sh
          chmod +x /shared/run-exporter.sh
      volumeMounts:
        - name: metrics-wrapper
          mountPath: /shared
  command: ["/shared/sh", "/shared/run-exporter.sh"]
  volumeMounts:
    - name: metrics-wrapper
      mountPath: /shared

extraVolumes:
  - name: metrics-wrapper
    emptyDir: {}

resources:
  limits:
    memory: 1Gi   # <-- Increased from 256Mi
    cpu: 500m
  requests:
    memory: 512Mi # <-- Increased from 128Mi
    cpu: 100m

persistence:
  etcPihole:
    enabled: true
    accessMode: ReadWriteOnce
    size: 5Gi
