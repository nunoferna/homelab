controller:
  type: daemonset
  tolerations:
    - effect: NoSchedule
      operator: Exists
    - effect: NoExecute
      operator: Exists

alloy:
  extraEnv:
    - name: NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName

  mounts:
    varlog: true
    dockercontainers: true

  configMap:
    create: true
    content: |
      // 1. Discovery: Find all pods
      discovery.kubernetes "pods" {
        role = "pod"
      }

      // 2. Relabeling: Filter to local node using the injected env var
      discovery.relabel "local_pods" {
        targets = discovery.kubernetes.pods.targets

        // Filter: Only keep pods on THIS node
        rule {
          source_labels = ["__meta_kubernetes_pod_node_name"]
          regex         = sys.env("NODE_NAME")
          action        = "keep"
        }

        // Map: Namespace
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }

        // Map: Pod Name
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }

        // Map: Container Name
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }

        // Map: App Label
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
          target_label  = "app"
        }

        // Map: Job Name
        rule {
          source_labels = ["__meta_kubernetes_namespace", "__meta_kubernetes_pod_label_app"]
          separator     = "/"
          target_label  = "job"
          replacement   = "$1"
        }
      }

      // 3. Source: Read logs
      loki.source.kubernetes "pod_logs" {
        targets    = discovery.relabel.local_pods.output
        forward_to = [loki.write.default.receiver]
      }

      // 4. Write: Send to Loki
      loki.write "default" {
        endpoint {
          url = "http://loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push"
        }
      }
