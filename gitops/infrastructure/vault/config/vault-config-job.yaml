apiVersion: batch/v1
kind: Job
metadata:
  name: vault-config
  namespace: vault
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: default
      restartPolicy: OnFailure
      containers:
        - name: configure
          image: hashicorp/vault:1.15
          env:
            - name: VAULT_ADDR
              value: "http://vault:8200"
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: vault-root-token
                  key: token
          command:
            - /bin/sh
            - -c
            - |
              set -e

              echo "Waiting for Vault to be ready..."
              until vault status; do sleep 2; done

              echo "Enabling KV v2 secrets engine..."
              vault secrets enable -path=secret kv-v2 || echo "Already enabled"

              echo "Creating policies..."
              vault policy write homelab-writer /policies/homelab-writer.hcl
              vault policy write homelab-reader /policies/homelab-reader.hcl

              echo "Enabling Kubernetes auth..."
              vault auth enable kubernetes || echo "Already enabled"

              echo "Configuring Kubernetes auth..."
              vault write auth/kubernetes/config \
                kubernetes_host="https://kubernetes.default.svc:443"

              echo "Enabling AppRole auth..."
              vault auth enable approle || echo "Already enabled"

              echo "Creating AppRole for CI..."
              vault write auth/approle/role/homelab-ci \
                token_policies=homelab-writer \
                token_ttl=1h \
                token_max_ttl=24h

              echo "âœ“ Vault configuration complete"
          volumeMounts:
            - name: policies
              mountPath: /policies
      volumes:
        - name: policies
          configMap:
            name: vault-policies
