backstage:
  command:
    - sh
  args:
    - -c
    - |
      . /vault/secrets/database
      . /vault/secrets/github
      exec node packages/backend \
        --config /app/app-config.yaml \
        --config /app/app-config-from-configmap.yaml
  podAnnotations:
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/role: "backstage"
    vault.hashicorp.com/agent-inject-secret-database: "database/creds/backstage-role"
    vault.hashicorp.com/agent-inject-template-database: |
      {{ `{{- with secret "database/creds/backstage-role" -}}` }}
      export POSTGRES_USER="{{ `{{ .Data.username }}` }}"
      export POSTGRES_PASSWORD="{{ `{{ .Data.password }}` }}"
      {{ `{{- end -}}` }}
    vault.hashicorp.com/agent-inject-secret-github: "secret/data/backstage/github"
    vault.hashicorp.com/agent-inject-template-github: |
      {{ `{{- with secret "secret/data/backstage/github" -}}` }}
      export GITHUB_CLIENT_ID="{{ `{{ .Data.data.client_id }}` }}"
      export GITHUB_CLIENT_SECRET="{{ `{{ .Data.data.client_secret }}` }}"
      export GITHUB_APP_ID="{{ `{{ .Data.data.app_id }}` }}"
      export GITHUB_PRIVATE_KEY="{{ `{{ .Data.data.private_key }}` }}"
      {{ `{{- end -}}` }}
    vault.hashicorp.com/agent-pre-populate-only: "true"

  image:
    registry: ghcr.io
    repository: nunoferna/homelab/backstage
    tag: main
    pullPolicy: Always

  appConfig:
    app:
      title: "Homelab Portal"
      baseUrl: https://backstage.home.lab
    backend:
      baseUrl: https://backstage.home.lab
      database:
        client: pg
        connection:
          host: backstage-postgresql
          port: 5432
          user: ${POSTGRES_USER}
          password: ${POSTGRES_PASSWORD}
          database: backstage
      reading:
        allow:
          - host: raw.githubusercontent.com
          - host: github.com
    signInPage: github
    auth:
      environment: production
      providers:
        github:
          production:
            clientId: ${GITHUB_CLIENT_ID}
            clientSecret: ${GITHUB_CLIENT_SECRET}
            signIn:
              resolvers:
                - resolver: usernameMatchingUserEntityName
    integrations:
      github:
        - host: github.com
          apps:
            - appId: "${GITHUB_APP_ID}"
              clientId: "${GITHUB_CLIENT_ID}"
              clientSecret: "${GITHUB_CLIENT_SECRET}"
              privateKey: |
                ${GITHUB_PRIVATE_KEY}
              webhookSecret: none
    catalog:
      locations:
        - type: url
          target: https://raw.githubusercontent.com/nunoferna/homelab/refs/heads/main/gitops/infrastructure/backstage/catalog/users.yaml
          rules:
            - allow: [User]
        - type: url
          target: https://raw.githubusercontent.com/nunoferna/homelab/refs/heads/main/gitops/infrastructure/backstage/catalog/groups.yaml
          rules:
            - allow: [Group]

serviceAccount:
  create: true
  name: backstage

postgresql:
  enabled: true
  auth:
    postgresPassword: rootpassword123
    username: backstage-unused
    password: unused
    database: backstage
